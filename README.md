在医疗数据上测试RAG效果
# 数据集
https://github.com/Toyhom/Chinese-medical-dialogue-data
从`样例_内科5000-6000.csv`中提取100条进行快速实验
# 模型
embedding模型:`gte-Qwen2-1.5B-instruct:latest`
rerank模型:`bge-reranker-base`
# 结果
## 直接使用用户输入进行全文检索:
`evaluation_bm25_2024-07-30 11:48:33.csv`
| retrievers       | hit_rate | mrr | cost_time          |
|------------------|----------|-----|--------------------|
| bm25_top_1_eval  | 0.0      | 0.0 | 393.0635452270508  |
| bm25_top_2_eval  | 0.0      | 0.0 | 383.9991092681885  |
| bm25_top_4_eval  | 0.0      | 0.0 | 358.5009574890137  |
| bm25_top_6_eval  | 0.0      | 0.0 | 394.84357833862305 |
| bm25_top_8_eval  | 0.0      | 0.0 | 380.7342052459717  |
| bm25_top_10_eval | 0.0      | 0.0 | 387.0398998260498  |

这里检索不到任何文档. 主要是`pg_search`的问题.
## 使用jieba分词提取用户输入关键词后再进行全文检索
`evaluation_bm25_jieba_2024-07-30 09:36:25.csv`
| retrievers      | hit_rate            | mrr                 | cost_time          |
|-----------------|---------------------|---------------------|--------------------|
| bm25_top_1_eval | 0.20202020202020202 | 0.20202020202020202 | 370.8987236022949  |
| bm25_top_2_eval | 0.25252525252525254 | 0.22727272727272727 | 362.1978759765625  |
| bm25_top_4_eval | 0.3333333333333333  | 0.2516835016835017  | 365.68140983581543 |
| bm25_top_5_eval | 0.3838383838383838  | 0.2617845117845118  | 360.0277900695801  |
| bm25_top_8_eval | 0.4444444444444444  | 0.27116402116402116 | 417.53244400024414 |

命中率较低, 推测原因是因为大部分回答包含的关键词相似.
## 使用向量检索
`evaluation_embedding_2024-07-30 11:45:46.csv`
| retrievers            | hit_rate           | mrr                | cost_time          |
|-----------------------|--------------------|--------------------|--------------------|
| embedding_top_1_eval  | 0.8383838383838383 | 0.8383838383838383 | 371.48261070251465 |
| embedding_top_2_eval  | 0.8888888888888888 | 0.8636363636363636 | 367.77257919311523 |
| embedding_top_4_eval  | 0.9494949494949495 | 0.8838383838383839 | 374.62568283081055 |
| embedding_top_6_eval  | 0.98989898989899   | 0.8912457912457913 | 417.81020164489746 |
| embedding_top_8_eval  | 1.0                | 0.8926887926887926 | 407.4873924255371  |
| embedding_top_10_eval | 1.0                | 0.8926887926887926 | 421.04554176330566 |

直接使用向量检索就能取的很好的效果. 这和数据集有很大的关系. 因为数据集中问题和回答具有很强的语义相关性.

## 混合检索: 全文检索+向量检索+rerank
`evaluation_ensemble_embedding_2024-07-30 14:09:56.csv`

| retrievers           | hit_rate           | mrr                | cost_time          |
|----------------------|--------------------|--------------------|--------------------|
| ensembel_top_1_eval  | 0.7474747474747475 | 0.7474747474747475 | 11393.540620803833 |
| ensembel_top_2_eval  | 0.7272727272727273 | 0.6818181818181818 | 12934.354782104492 |
| ensembel_top_4_eval  | 0.8383838383838383 | 0.6784511784511783 | 17545.891523361206 |
| ensembel_top_6_eval  | 0.8888888888888888 | 0.6702020202020201 | 19292.78326034546  |
| ensembel_top_8_eval  | 0.9393939393939394 | 0.6607383357383357 | 21426.180839538574 |
| ensembel_top_10_eval | 0.9090909090909091 | 0.6495831329164662 | 24088.55938911438  |

混合检索的结果反而比向量检索更差,这和直接违背. 推测主要还是全文检索在数据集上的效果太差导致.

# 结论
在医疗问答数据集上, 由于提问和回答文档具有很强的语义相关性, 所以直接使用向量检索就可以取得很好的效果.
全文检索在该场景表现不佳, 主要有两个原因:
1. 全文检索更适用于用户输入为关键词的场景.
2. `pg_search`的全文检索无法检索到文档, 导致需要对用户输入进行分词处理. 由于数据集上不同回答包含的关键词比较类似, 进而影响检索效果.